function MarkerManager(a){this.init(a)}MarkerManager.prototype.init=function(b){var a=b||{};if(a.map==undefined){}if(a.gridSize==undefined){a.gridSize=15}if(a.mapView==undefined){a.mapView=false}if(a.listView==undefined){a.listView=false}if(a.createEvent==undefined){a.createEvent=false}this.setValues_(a);that=this;google.maps.event.addListenerOnce(this.map_,"idle",function(){that.placeAllMarkers()});this.projectionHelper_=new ProjectionHelperOverlay_(this.map_);this.infoWindow_=new InfoWindow(this);if(this.mapView_){$.each($(".result-list-item"),function(c,d){$(d).hide()})}};MarkerManager.prototype.setValues_=function(a){this.map_=a.map;this.gridSize_=a.gridSize;this.mapView_=a.mapView;this.listView_=a.listView;this.createEvent_=a.createEvent;this.allMarkers_=[];this.selectedMarker_=null};MarkerManager.prototype.createMarker=function(f,h,g,i,e,a){if(a==undefined){a=false}var j="/images/map_pin.png";var b=a;if(this.mapView_||this.listView_){if(h==$("#selected_searchable").val()){j="/images/ico-pin-selected.png";b=true}}else{if(this.createEvent_){if(this.selectedMarker_&&this.selectedMarker_.getPosition().equals(f)){j="/images/ico-pin-selected.png";b=true}}}var c=new google.maps.Marker({position:f,icon:j,title:(g||i)});c.setMap(null);c.searchableID_=h;c.geocodableAddress_=i||g;c.clusteredMarkers_=[];c.selected_=b;c.preserveMarker_=e;c.label_=new Label();c.label_.set("zIndex",c.getZIndex()-100);c.label_.bindTo("position",c,"position");c.label_.set("text","");if(b){this.userSelectMarker_(c)}if(this.mapView_||this.listView_||this.createEvent_){var d=this;google.maps.event.addListener(c,"click",function(){c.setIcon("/images/ico-pin-selected.png");d.userSelectMarker_(this);d.setSelectedMarker_(this)})}this.allMarkers_.push(c);if(e){c.selected_=true;this.placeAllMarkers()}};MarkerManager.prototype.clearMarkers=function(){var a=[];$.each(this.allMarkers_,function(c,b){if(b.preserveMarker_){a.push(b)}else{b.setMap(null);b.label_.setMap(null)}});delete this.allMarkers_;this.allMarkers_=a;$(".address").html("")};MarkerManager.prototype.placeAllMarkers=function(){if(undefined==this.map_.mapTypes[this.map_.mapTypeId]){that=this;google.maps.event.addListenerOnce(this.map_,"idle",function(){that.placeAllMarkers()});return}var d=null;var c=this.allMarkers_.slice(0);this.allMarkers_=[];for(var a=0;marker=c[a];a++){this.resetMarker_(marker);if(!marker.preserveMarker_&&null!=(ownerMarker=this.clusterWith_(marker))){if(!ownerMarker.clusteredMarkers_){ownerMarker.clusteredMarkers_=[]}ownerMarker.clusteredMarkers_.push(marker);if(marker.selected_){d=ownerMarker}ownerMarker.label_.set("text",ownerMarker.clusteredMarkers_.length+1)}else{if(marker.selected_){d=marker}marker.setMap(this.map_);marker.label_.set("map",this.map_);var b=new google.maps.LatLngBounds(marker.getPosition(),marker.getPosition());marker.extendedBounds_=this.getExtendedBounds_(b)}this.allMarkers_.push(marker)}if(d){this.setSelectedMarker_(d)}else{if(this.mapView_){$(".address").html("")}}delete c;c=null};MarkerManager.prototype.resetMarker_=function(a){delete a.clusteredMarkers_;a.clusteredMarkers_=[];a.extendedBounds_=null;a.setMap(null);a.label_.set("text","");a.label_.set("map",null);a.setIcon("/images/map_pin.png")};MarkerManager.prototype.userSelectMarker_=function(a){a.selected_=true;if(this.mapView_){if(a.geocodableAddress_!=null){$(".address").html("Near "+a.geocodableAddress_)}else{$(".address").html("")}$("#selected_searchable").val(a.searchableID_)}else{if(this.listView_){$("#selected_searchable").val(a.searchableID_)}else{if(this.createEvent_){}}}};MarkerManager.prototype.setSelectedMarker_=function(a){if(this.selectedMarker_!=null&&this.selectedMarker_!=a){this.selectedMarker_.setIcon("/images/map_pin.png");this.selectedMarker_.selected_=false;if(this.selectedMarker_.clusteredMarkers_){$.each(this.selectedMarker_.clusteredMarkers_,function(d,c){c.selected_=false})}}this.selectedMarker_=a;this.selectedMarker_.setIcon("/images/ico-pin-selected.png");if(this.mapView_){$.each($(".result-list-item"),function(c,d){$(d).hide()});$("#result_for_searchable_"+this.selectedMarker_.searchableID_).show();if(this.selectedMarker_.clusteredMarkers_){$.each(this.selectedMarker_.clusteredMarkers_,function(d,c){$("#result_for_searchable_"+c.searchableID_).show()})}}else{if(this.listView_){$.each($(".result-list-item"),function(c,d){$(d).css("backgroundColor","transparent")});$("#result_for_searchable_"+this.selectedMarker_.searchableID_).css("backgroundColor","#fffcd5");if(this.selectedMarker_.clusteredMarkers_){$.each(this.selectedMarker_.clusteredMarkers_,function(d,c){$("#result_for_searchable_"+c.searchableID_).css("backgroundColor","#fffcd5")})}}else{if(this.createEvent_){this.infoWindow_.addInfoWindow_(this.selectedMarker_);var b=this.selectedMarker_.getPosition();$("#location-lat-field").val(b.lat());$("#location-lng-field").val(b.lng());$("#location-geocodedaddress-field").val(this.selectedMarker_.geocodableAddress_);$(".location-address-field").val(this.selectedMarker_.geocodableAddress_)}}}};MarkerManager.prototype.clusterWith_=function(c){var h=40000;var g=null;var e=c.getPosition();for(var b=0;placedMarker=this.allMarkers_[b];b++){if(placedMarker.getMap()){var a=placedMarker.getPosition();if(a){var f=this.distanceBetweenPoints_(a,e);if(f<h){h=f;g=placedMarker}}}}if(g&&this.isWithinMarkerBound_(g,e)){return g}else{return null}};MarkerManager.prototype.distanceBetweenPoints_=function(g,i){if(!g||!i){return 0}var h=6371;var e=(i.lat()-g.lat())*Math.PI/180;var f=(i.lng()-g.lng())*Math.PI/180;var b=Math.sin(e/2)*Math.sin(e/2)+(Math.cos(g.lat()*Math.PI/180)*Math.cos(i.lat()*Math.PI/180)*Math.sin(f/2)*Math.sin(f/2));var k=2*Math.atan2(Math.sqrt(b),Math.sqrt(1-b));var j=h*k;return j};MarkerManager.prototype.isWithinMarkerBound_=function(b,a){return b.extendedBounds_.contains(a)};MarkerManager.prototype.getExtendedBounds_=function(e){var c=this.projectionHelper_.getProjection();var f=new google.maps.LatLng(e.getNorthEast().lat(),e.getNorthEast().lng());var h=new google.maps.LatLng(e.getSouthWest().lat(),e.getSouthWest().lng());var d=c.fromLatLngToDivPixel(f);d.x+=this.gridSize_;d.y-=this.gridSize_;var b=c.fromLatLngToDivPixel(h);b.x-=this.gridSize_;b.y+=this.gridSize_;var g=c.fromDivPixelToLatLng(d);var a=c.fromDivPixelToLatLng(b);e.extend(g);e.extend(a);return e};function ProjectionHelperOverlay_(a){google.maps.OverlayView.call(this);this.setMap(a)}ProjectionHelperOverlay_.prototype=new google.maps.OverlayView();ProjectionHelperOverlay_.prototype.draw=function(){if(!this.ready){this.ready=true;google.maps.event.trigger(this,"ready")}};function InfoWindow(a){this.markerManager_=a;this.infoBubble_=new InfoBubble({disableAutoPan:true});this.infoBubble_.hideCloseButton();var b=this;$("#marker-name-field").live("click",function(){$(this).focus()});$("#marker-name-field").live("keyup",function(c){if(c.keyCode==13){if(this.value.length>0){$(this).siblings("a").html(this.value)}else{$(this).siblings("a").html("Add place name")}b.infoBubble_.setMinWidth($(this).siblings("a").html().length*7.5);b.infoBubble_.setPadding(5);b.infoBubble_.setBorderWidth(5);$(this).siblings("a").show();$(this).hide();c.stopPropagation();return false}else{$("#location-name-field").val(this.value);getCreateMarkerManager().selectedMarker_.setTitle(this.value);return true}return false})}InfoWindow.prototype.addInfoWindow_=function(a){var c=(a.title!=""&&$("#location-name-field").val()==a.title)?a.title:"Add place name";var b='<div style=\'text-align:center;\'><input id="marker-name-field" type="text" value="'+a.title+'" style=\'display:none; width: 200px; border:0; margin:0;\'/><a href="#" onclick="getCreateMarkerManager().infoWindow_.labelClicked(this); return false;" id="infobubble-link">'+c+"</a></div>";this.infoBubble_.setContent(b);this.infoBubble_.setMaxHeight(20);this.infoBubble_.setMinHeight(10);this.infoBubble_.setMinWidth(c.length*6.5);this.infoBubble_.setBorderWidth(5);this.infoBubble_.setPadding(5);this.infoBubble_.open(this.markerManager_.map_,a)};InfoWindow.prototype.labelClicked=function(a){$(a).siblings("input").show().focus();this.infoBubble_.setMinHeight(20);this.infoBubble_.setMinWidth(200);this.infoBubble_.setPadding(0);this.infoBubble_.setBorderWidth(5);$(a).hide()};function Label(b){this.setValues(b);var a=this.span_=document.createElement("span");a.style.cssText="white-space: nowrap; color:#FF0000;font-family: Arial; font-weight: bold;font-size: 8px;";var c=this.div_=document.createElement("div");c.appendChild(a);c.style.cssText="position: absolute; display: none"}Label.prototype=new google.maps.OverlayView;Label.prototype.onAdd=function(){var b=this.getPanes().overlayImage;b.appendChild(this.div_);var a=this;this.listeners_=[google.maps.event.addListener(this,"position_changed",function(){a.draw()}),google.maps.event.addListener(this,"text_changed",function(){a.draw()}),google.maps.event.addListener(this,"zindex_changed",function(){a.draw()})]};Label.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_);for(var b=0,a=this.listeners_.length;b<a;++b){google.maps.event.removeListener(this.listeners_[b])}};Label.prototype.draw=function(){var b=this.getProjection();var a=b.fromLatLngToDivPixel(this.get("position"));var c=this.div_;c.style.left=(a.x-11)+"px";c.style.top=(a.y-35)+"px";c.style.width="22px";c.style.textAlign="center";c.style.display="block";this.span_.innerHTML=this.get("text").toString()};function Pageless(a){this.stop();this.init(a)}Pageless.prototype.init=function(c){var b=c||{};if(b.container==undefined){b.container=this.container_||window}if(b.currentPage==undefined){b.currentPage=this.current_page_||1}if(b.totalPages==undefined){b.totalPages=this.totalPages_||1}if(b.distance==undefined){b.distance=this.distance_||100}if(b.loaderContainer==undefined){b.loaderContainer=this.loaderContainer_||b.container}if(b.loaderHtml==undefined){b.loaderHtml=this.loaderHtml_||'            <div id="pageless-loader" style="display:none;text-align:center;width:100%;">            <div class="msg" style="color:#e9e9e9;font-size:2em">Loading...</div>            <img src="/images/load.gif" alt="loading more results" style="margin:10px auto" />            </div>'}if(b.url==undefined){b.url=this.url_||""}if(b.parameterFunction==undefined){b.parameterFunction=this.parameterFunction_||""}this.setValues(b);var a=$(this.loaderContainer_);var d=a.find("#pageless-loader");if(d.length<=0){this.loader_=$(this.loaderHtml_);a.append(this.loader_)}else{this.loader_=d}};Pageless.prototype.setValues=function(a){this.container_=a.container;this.container_dom_=$(this.container_);this.currentPage_=a.currentPage;this.totalPages_=a.totalPages;this.url_=a.url;this.parameterFunction_=a.parameterFunction;this.distance_=a.distance;this.loaderHtml_=a.loaderHtml;this.loaderContainer_=a.loaderContainer;this.isLoading_=this.isLoading||false};Pageless.prototype.loading=function(a){(this.isLoading_=a)?(this.loader_&&this.loader_.fadeIn("normal")):(this.loader_&&this.loader_.fadeOut("normal"))};Pageless.prototype.distanceToBottom=function(){return(this.container_===window)?$(document).height()-this.container_dom_.scrollTop()-this.container_dom_.height():this.container_dom_[0].scrollHeight-this.container_dom_.scrollTop()-this.container_dom_.height()};Pageless.prototype.watch=function(a){if(a.totalPages_<=a.currentPage_){a.stop();a.loading(false);return}else{if(!a.isLoading_&&(a.distanceToBottom()<a.distance_)){a.loading(true);a.currentPage_++;params={};if($.isFunction(a.parameterFunction_)){params=a.parameterFunction_()}$.extend(params,{page:a.currentPage_});$.get(a.url_,params,function(b){if(a.loader_){a.loader_.before(b);a.loading(false)}else{}})}}};Pageless.prototype.reset=function(a){this.init(a);this.stop();this.loading(false);this.start()};Pageless.prototype.start=function(){var a=this;this.container_dom_.bind("scroll.ss_pageless",function(){a.watch(a)});this.container_dom_.bind("resize.ss_pageless",function(){a.watch(a)})};Pageless.prototype.stop=function(){if(this.container_dom_){this.container_dom_.unbind("scroll.ss_pageless");this.container_dom_.unbind("resize.ss_pageless")}};function addKeyword(c,b){if($(b+' .keyword-pill input[type="hidden"][value="'+c.replace("+"," ")+'"]').size()>0||c==""){return false}var a;if(b=="#event-keywords"){a="event[searchable_attributes][keywords][]"}else{a="keywords[]"}$('<li class="keyword-pill" container-selector = "'+b+'">'+c.replace("+"," ")+'<a href="#" class="close remove-parent" data-parent-selector = ".keyword-pill">close</a><input type="hidden" name="'+a+'" value="'+c.replace("+"," ")+'" /></li>').hide().appendTo($(b)).fadeIn("slow");if(b=="#explore-keywords"){}if(typeof checkMapPageSize=="function"){checkMapPageSize()}return true}function removeKeyword(a){var d=$(".keyword-pill:contains('"+a+"')").children("a");if(d.length!=0){var b=$(d);var c=b.data("parent-selector");if(c){b.closest(c).remove()}if(c=="#explore-keywords"){}}}function existingKeywords(a){var c=$(a).children();var b=new Array();$.each(c,function(d,e){$.each($(e).children(),function(g,f){if(f.tagName=="INPUT"){b.push($(f).val())}})});return b}function arraySubtract(b,a){var c=new Array();$.each(b,function(d,e){if($.inArray(e,a)==-1){c.push(e)}});return c}$(function(){function b(d,f){if(addKeyword(d,f)){if(typeof refreshResults=="function"){if(e=="explore"&&history&&history.pushState){history.pushState(null,null,getSearchParams())}var e;if(f=="#explore-keywords"){e="explore"}else{e="events"}refreshResults(e)}}}$(".keyword-pill").live("ss:removed",function(){if(typeof refreshResults=="function"){var d;if($(this).attr("container-selector")=="#explore-keywords"){d="explore"}else{d="events"}if(d=="explore"&&history&&history.pushState){history.pushState(null,null,getSearchParams())}refreshResults(d)}if(typeof checkMapPageSize=="function"){checkMapPageSize()}});$(".q-textfield").keydown(function(d){if(d.keyCode==13){b(this.value,$(this).attr("keyword-content-selector"));this.value="";$(this).autocomplete("close");return false}return true});$(".q-textfield").bind("autocompletechange",function(d){b(this.value,$(this).attr("keyword-content-selector"));this.value="";return false});var a={},c;$(".q-textfield").autocomplete({minLength:1,autofill:true,delay:100,source:function(f,d){var e=f.term;c=$.getJSON(keywordsJsonURL,f,function(h,g,i){if(h.indexOf(e)<0){h.unshift(e.toString())}a[e]=h;if(i===c){d(h)}})},select:function(d,e){b(e.item.value,$(this).attr("keyword-content-selector"));this.value="";$(".q-textfield").val("");return false},html:true})});jQuery.fn.extend({getUrlParam:function(h){strParamName=escape(unescape(h));var f=new Array();var b=null;if($(this).attr("nodeName")=="#document"){if(escape(unescape(window.location.search)).search(strParamName)>-1){b=window.location.search.substr(1,window.location.search.length).split("&")}}else{if($(this).attr("src")!="undefined"){var e=$(this).attr("src");if(e.indexOf("?")>-1){var a=e.substr(e.indexOf("?")+1);b=a.split("&")}}else{if($(this).attr("href")!="undefined"){var e=$(this).attr("href");if(e.indexOf("?")>-1){var a=e.substr(e.indexOf("?")+1);b=a.split("&")}}else{return null}}}if(b==null){return null}for(var d=0;d<b.length;d++){var c=b[d].indexOf("=");if(c>=0){var g=escape(unescape(b[d].substr(0,c)));if(g==strParamName){f.push(unescape(b[d].substr(c+1)))}}}if(f.length==0){return null}else{if(f.length==1){return f[0]}else{return f}}}});