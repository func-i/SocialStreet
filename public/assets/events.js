function MarkerManager(a){this.init(a)}MarkerManager.prototype.init=function(b){var a=b||{};if(a.map==undefined){}if(a.gridSize==undefined){a.gridSize=15}if(a.mapView==undefined){a.mapView=false}if(a.listView==undefined){a.listView=false}if(a.createEvent==undefined){a.createEvent=false}this.setValues_(a);that=this;google.maps.event.addListenerOnce(this.map_,"idle",function(){that.placeAllMarkers()});this.projectionHelper_=new ProjectionHelperOverlay_(this.map_);this.infoWindow_=new InfoWindow(this);if(this.mapView_){$.each($(".result-list-item"),function(d,e){$(e).hide()})}};MarkerManager.prototype.setValues_=function(a){this.map_=a.map;this.gridSize_=a.gridSize;this.mapView_=a.mapView;this.listView_=a.listView;this.createEvent_=a.createEvent;this.allMarkers_=[];this.selectedMarker_=null};MarkerManager.prototype.createMarker=function(g,i,h,j,f,a){if(a==undefined){a=false}var k="/images/map_pin.png";var b=a;if(this.mapView_||this.listView_){if(i==$("#selected_searchable").val()){k="/images/ico-pin-selected.png";b=true}}else{if(this.createEvent_){if(this.selectedMarker_&&this.selectedMarker_.getPosition().equals(g)){k="/images/ico-pin-selected.png";b=true}}}var d=new google.maps.Marker({position:g,icon:k,title:(h||j)});d.setMap(null);d.searchableID_=i;d.geocodableAddress_=j||h;d.clusteredMarkers_=[];d.selected_=b;d.preserveMarker_=f;d.label_=new Label();d.label_.set("zIndex",d.getZIndex()-100);d.label_.bindTo("position",d,"position");d.label_.set("text","");if(b){this.userSelectMarker_(d)}if(this.mapView_||this.listView_||this.createEvent_){var e=this;google.maps.event.addListener(d,"click",function(){d.setIcon("/images/ico-pin-selected.png");e.userSelectMarker_(this);e.setSelectedMarker_(this)})}this.allMarkers_.push(d);if(f){d.selected_=true;this.placeAllMarkers()}};MarkerManager.prototype.clearMarkers=function(){var a=[];$.each(this.allMarkers_,function(d,b){if(b.preserveMarker_){a.push(b)}else{b.setMap(null);b.label_.setMap(null)}});delete this.allMarkers_;this.allMarkers_=a;$(".address").html("")};MarkerManager.prototype.placeAllMarkers=function(){if(undefined==this.map_.mapTypes[this.map_.mapTypeId]){that=this;google.maps.event.addListenerOnce(this.map_,"idle",function(){that.placeAllMarkers()});return}var e=null;var d=this.allMarkers_.slice(0);this.allMarkers_=[];for(var a=0;marker=d[a];a++){this.resetMarker_(marker);if(!marker.preserveMarker_&&null!=(ownerMarker=this.clusterWith_(marker))){if(!ownerMarker.clusteredMarkers_){ownerMarker.clusteredMarkers_=[]}ownerMarker.clusteredMarkers_.push(marker);if(marker.selected_){e=ownerMarker}ownerMarker.label_.set("text",ownerMarker.clusteredMarkers_.length+1)}else{if(marker.selected_){e=marker}marker.setMap(this.map_);marker.label_.set("map",this.map_);var b=new google.maps.LatLngBounds(marker.getPosition(),marker.getPosition());marker.extendedBounds_=this.getExtendedBounds_(b)}this.allMarkers_.push(marker)}if(e){this.setSelectedMarker_(e)}else{if(this.mapView_){$(".address").html("")}}delete d;d=null};MarkerManager.prototype.resetMarker_=function(a){delete a.clusteredMarkers_;a.clusteredMarkers_=[];a.extendedBounds_=null;a.setMap(null);a.label_.set("text","");a.label_.set("map",null);a.setIcon("/images/map_pin.png")};MarkerManager.prototype.userSelectMarker_=function(a){a.selected_=true;if(this.mapView_){if(a.geocodableAddress_!=null){$(".address").html("Near "+a.geocodableAddress_)}else{$(".address").html("")}$("#selected_searchable").val(a.searchableID_)}else{if(this.listView_){$("#selected_searchable").val(a.searchableID_)}else{if(this.createEvent_){}}}};MarkerManager.prototype.setSelectedMarker_=function(a){if(this.selectedMarker_!=null&&this.selectedMarker_!=a){this.selectedMarker_.setIcon("/images/map_pin.png");this.selectedMarker_.selected_=false;if(this.selectedMarker_.clusteredMarkers_){$.each(this.selectedMarker_.clusteredMarkers_,function(e,d){d.selected_=false})}}this.selectedMarker_=a;this.selectedMarker_.setIcon("/images/ico-pin-selected.png");if(this.mapView_){$.each($(".result-list-item"),function(d,e){$(e).hide()});$("#result_for_searchable_"+this.selectedMarker_.searchableID_).show();if(this.selectedMarker_.clusteredMarkers_){$.each(this.selectedMarker_.clusteredMarkers_,function(e,d){$("#result_for_searchable_"+d.searchableID_).show()})}}else{if(this.listView_){$.each($(".result-list-item"),function(d,e){$(e).css("backgroundColor","transparent")});$("#result_for_searchable_"+this.selectedMarker_.searchableID_).css("backgroundColor","#fffcd5");if(this.selectedMarker_.clusteredMarkers_){$.each(this.selectedMarker_.clusteredMarkers_,function(e,d){$("#result_for_searchable_"+d.searchableID_).css("backgroundColor","#fffcd5")})}}else{if(this.createEvent_){this.infoWindow_.addInfoWindow_(this.selectedMarker_);var b=this.selectedMarker_.getPosition();$("#location-lat-field").val(b.lat());$("#location-lng-field").val(b.lng());$("#location-geocodedaddress-field").val(this.selectedMarker_.geocodableAddress_);$(".location-address-field").val(this.selectedMarker_.geocodableAddress_)}}}};MarkerManager.prototype.clusterWith_=function(e){var j=40000;var h=null;var f=e.getPosition();for(var b=0;placedMarker=this.allMarkers_[b];b++){if(placedMarker.getMap()){var a=placedMarker.getPosition();if(a){var g=this.distanceBetweenPoints_(a,f);if(g<j){j=g;h=placedMarker}}}}if(h&&this.isWithinMarkerBound_(h,f)){return h}else{return null}};MarkerManager.prototype.distanceBetweenPoints_=function(g,i){if(!g||!i){return 0}var h=6371;var e=(i.lat()-g.lat())*Math.PI/180;var f=(i.lng()-g.lng())*Math.PI/180;var b=Math.sin(e/2)*Math.sin(e/2)+(Math.cos(g.lat()*Math.PI/180)*Math.cos(i.lat()*Math.PI/180)*Math.sin(f/2)*Math.sin(f/2));var k=2*Math.atan2(Math.sqrt(b),Math.sqrt(1-b));var j=h*k;return j};MarkerManager.prototype.isWithinMarkerBound_=function(b,a){return b.extendedBounds_.contains(a)};MarkerManager.prototype.getExtendedBounds_=function(f){var d=this.projectionHelper_.getProjection();var g=new google.maps.LatLng(f.getNorthEast().lat(),f.getNorthEast().lng());var i=new google.maps.LatLng(f.getSouthWest().lat(),f.getSouthWest().lng());var e=d.fromLatLngToDivPixel(g);e.x+=this.gridSize_;e.y-=this.gridSize_;var b=d.fromLatLngToDivPixel(i);b.x-=this.gridSize_;b.y+=this.gridSize_;var h=d.fromDivPixelToLatLng(e);var a=d.fromDivPixelToLatLng(b);f.extend(h);f.extend(a);return f};function ProjectionHelperOverlay_(a){google.maps.OverlayView.call(this);this.setMap(a)}ProjectionHelperOverlay_.prototype=new google.maps.OverlayView();ProjectionHelperOverlay_.prototype.draw=function(){if(!this.ready){this.ready=true;google.maps.event.trigger(this,"ready")}};function InfoWindow(a){this.markerManager_=a;this.infoBubble_=new InfoBubble({disableAutoPan:true});this.infoBubble_.hideCloseButton();var b=this;$("#marker-name-field").live("click",function(){$(this).focus()});$("#marker-name-field").live("keyup",function(d){if(d.keyCode==13){if(this.value.length>0){$(this).siblings("a").html(this.value)}else{$(this).siblings("a").html("Add place name")}b.infoBubble_.setMinWidth($(this).siblings("a").html().length*7.5);b.infoBubble_.setPadding(5);b.infoBubble_.setBorderWidth(5);$(this).siblings("a").show();$(this).hide();d.stopPropagation();return false}else{$("#location-name-field").val(this.value);getCreateMarkerManager().selectedMarker_.setTitle(this.value);return true}return false})}InfoWindow.prototype.addInfoWindow_=function(a){var d=(a.title!=""&&$("#location-name-field").val()==a.title)?a.title:"Add place name";var b='<div style=\'text-align:center;\'><input id="marker-name-field" type="text" value="'+a.title+'" style=\'display:none; width: 200px; border:0; margin:0;\'/><a href="#" onclick="getCreateMarkerManager().infoWindow_.labelClicked(this); return false;" id="infobubble-link">'+d+"</a></div>";this.infoBubble_.setContent(b);this.infoBubble_.setMaxHeight(20);this.infoBubble_.setMinHeight(10);this.infoBubble_.setMinWidth(d.length*6.5);this.infoBubble_.setBorderWidth(5);this.infoBubble_.setPadding(5);this.infoBubble_.open(this.markerManager_.map_,a)};InfoWindow.prototype.labelClicked=function(a){$(a).siblings("input").show().focus();this.infoBubble_.setMinHeight(20);this.infoBubble_.setMinWidth(200);this.infoBubble_.setPadding(0);this.infoBubble_.setBorderWidth(5);$(a).hide()};function Label(b){this.setValues(b);var a=this.span_=document.createElement("span");a.style.cssText="white-space: nowrap; color:#FF0000;font-family: Arial; font-weight: bold;font-size: 8px;";var d=this.div_=document.createElement("div");d.appendChild(a);d.style.cssText="position: absolute; display: none"}Label.prototype=new google.maps.OverlayView;Label.prototype.onAdd=function(){var b=this.getPanes().overlayImage;b.appendChild(this.div_);var a=this;this.listeners_=[google.maps.event.addListener(this,"position_changed",function(){a.draw()}),google.maps.event.addListener(this,"text_changed",function(){a.draw()}),google.maps.event.addListener(this,"zindex_changed",function(){a.draw()})]};Label.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_);for(var b=0,a=this.listeners_.length;b<a;++b){google.maps.event.removeListener(this.listeners_[b])}};Label.prototype.draw=function(){var b=this.getProjection();var a=b.fromLatLngToDivPixel(this.get("position"));var d=this.div_;d.style.left=(a.x-11)+"px";d.style.top=(a.y-35)+"px";d.style.width="22px";d.style.textAlign="center";d.style.display="block";this.span_.innerHTML=this.get("text").toString()};var geocoder;var map;var infoWindow;var dropPinState=false;var controlUI=null;var overlay;var createMarkerManager;var toronto=new google.maps.LatLng(43.7427662,-79.3922001);function getCreateMarkerManager(){return createMarkerManager}$(function(){var f;var d=$("#users-current-location");if(d.length>0&&d.val()){var i=$("#users-current-location").val().split(",");f=new google.maps.LatLng(i[0],i[1])}else{f=toronto}var j={zoom:13,center:f,mapTypeControl:false,mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:false};map=new google.maps.Map(document.getElementById("event-location-map"),j);var g=document.createElement("IMG");g.src="/images/ico-pin.png";var b=document.createElement("DIV");var e=new DropPinControl(g,b,map);map.controls[google.maps.ControlPosition.TOP_RIGHT].push(g);map.controls[google.maps.ControlPosition.RIGHT_TOP].push(b);var a={coords:[0,0,0,0],type:"rect"};var h=new google.maps.Marker({map:map,icon:"http://www.daftlogic.com/images/cross-hairs.gif",shape:a});h.bindTo("position",map,"center");createMarkerManager=new MarkerManager({map:map,gridSize:15,createEvent:true});geocoder=new google.maps.Geocoder();overlay=new google.maps.OverlayView();overlay.draw=function(){};overlay.setMap(map)});function disableDropPinState(){dropPinState=false;controlUI.style.backgroundColor="white"}function DropPinControl(b,a,d){b.style.paddingTop="5px";b.style.marginRight="48px";b.style.cursor="pointer";b.onmouseover=function(){this.src="/images/ico-pin-hover.png"};b.onmouseout=function(){this.src="/images/ico-pin.png"};a.style.marginRight="10px";a.style.padding="5px";a.style.backgroundColor="white";a.style.color="#0981BE";a.style.fontFamily="Arial,sans-serif";a.style.fontSize="14px";a.innerHTML="Drag & Drop Pin";$(b).draggable({helper:"clone",drag:function(e,f){dropPinState=true},stop:function(g,h){var f=new ProjectionHelperOverlay(d);var j=f.getProjection().fromContainerPixelToLatLng(new google.maps.Point(h.position.left+20,h.position.top+48));var e=new google.maps.LatLng(j.lat(),j.lng());var i="";geocoder.geocode({location:e},function(l,k){if(k==google.maps.GeocoderStatus.OK){i=l[0].formatted_address}createMarkerManager.createMarker(e,null,null,i,true);d.setCenter(e)});dropPinState=false}})}function ProjectionHelperOverlay(a){google.maps.OverlayView.call(this);this.setMap(a)}ProjectionHelperOverlay.prototype=new google.maps.OverlayView();ProjectionHelperOverlay.prototype.draw=function(){if(!this.ready){this.ready=true;google.maps.event.trigger(this,"ready")}};function searchLocations(a){var b=a.target.value;geocoder.geocode({address:b,bounds:map.getBounds()},function(h,g){if(g==google.maps.GeocoderStatus.OK){$.each(h,function(n,m){var l={};$.each(m.address_components,function(p,o){l[o.types["0"]]=o.short_name});createMarkerManager.createMarker(m.geometry.location,null,null,a.target.value,true);map.setCenter(m.geometry.location)})}else{if(g==google.maps.GeocoderStatus.ZERO_RESULTS){var e=map.getBounds().getSouthWest();var k=map.getBounds().getNorthEast();var i=e.lat(),d=e.lng();var f=k.lat(),j=k.lng();$.getJSON(locationSearchURL,{query:b,sw_lat:i,sw_lng:d,ne_lat:f,ne_lng:j},function(m,n,l){if(m.length>0){$.each(m,function(q,o){var p=new google.maps.LatLng(o.latitude,o.longitude);createMarkerManager.createMarker(p,null,null,o.text,true);map.setCenter(p)})}else{alert("No results found, please drop a pin to tell us where this is")}})}else{alert("Geocode was not successful for the following reason: "+g)}}});return false}$(".location-address-field").keydown(function(a){if(a.keyCode==13){$("#location-name-field").val("");searchLocations(a);a.stopPropagation();return false}return true});$(".location-address-field").change(function(a){$("#location-name-field").val("");searchLocations(a);a.stopPropagation();return false});$(function(){function b(d){var f=d.target.value;geocoder.geocode({address:f},function(g,e){if(e==google.maps.GeocoderStatus.OK){map.setCenter(g[0].geometry.location);a();$("#location-not-found").hide()}else{if(e==google.maps.GeocoderStatus.ZERO_RESULTS){$("#location-not-found").show()}}})}function a(d){setTimeout(function(){var e=map.getZoom();$("#map_zoom").val(e);bounds=map.getBounds();ne=bounds.getNorthEast();sw=bounds.getSouthWest();c=bounds.getCenter();$("#map_bounds").val(ne.lat()+","+ne.lng()+","+sw.lat()+","+sw.lng());$("#map_center").val(c.lat()+","+c.lng());if(history&&history.replaceState){refreshResults("events")}},15)}google.maps.event.addListener(map,"zoom_changed",a);google.maps.event.addListener(map,"dragend",a);google.maps.event.addListener(map,"resize",a)});$(function(){$("#starts_at_calendar").datepicker({dateFormat:"yy-mm-dd",showOn:"both",buttonImage:"/images/calendar_grey.png",buttonImageOnly:true});$(".starts-at-time").change(function(){var b=$($(".starts-at-time")[1]).val();var a=$($(".starts-at-time")[3]).val();if(a=="PM"){b=parseInt(b,10)+12}$(".starts-at-value").val($("#starts_at_calendar").val()+" "+b+":"+$($(".starts-at-time")[2]).val())})});function addKeyword(d,b){if($(b+' .keyword-pill input[type="hidden"][value="'+d.replace("+"," ")+'"]').size()>0||d==""){return false}var a;if(b=="#event-keywords"){a="event[searchable_attributes][keywords][]"}else{a="keywords[]"}$('<li class="keyword-pill" container-selector = "'+b+'">'+d.replace("+"," ")+'<a href="#" class="close remove-parent" data-parent-selector = ".keyword-pill">close</a><input type="hidden" name="'+a+'" value="'+d.replace("+"," ")+'" /></li>').hide().appendTo($(b)).fadeIn("slow");if(b=="#explore-keywords"){}if(typeof checkMapPageSize=="function"){checkMapPageSize()}return true}function removeKeyword(a){var e=$(".keyword-pill:contains('"+a+"')").children("a");if(e.length!=0){var b=$(e);var d=b.data("parent-selector");if(d){b.closest(d).remove()}if(d=="#explore-keywords"){}}}function existingKeywords(a){var d=$(a).children();var b=new Array();$.each(d,function(e,f){$.each($(f).children(),function(h,g){if(g.tagName=="INPUT"){b.push($(g).val())}})});return b}function arraySubtract(b,a){var d=new Array();$.each(b,function(e,f){if($.inArray(f,a)==-1){d.push(f)}});return d}$(function(){function b(e,g){if(addKeyword(e,g)){if(typeof refreshResults=="function"){if(f=="explore"&&history&&history.pushState){history.pushState(null,null,getSearchParams())}var f;if(g=="#explore-keywords"){f="explore"}else{f="events"}refreshResults(f)}}}$(".keyword-pill").live("ss:removed",function(){if(typeof refreshResults=="function"){var e;if($(this).attr("container-selector")=="#explore-keywords"){e="explore"}else{e="events"}if(e=="explore"&&history&&history.pushState){history.pushState(null,null,getSearchParams())}refreshResults(e)}if(typeof checkMapPageSize=="function"){checkMapPageSize()}});$(".q-textfield").keydown(function(f){if(f.keyCode==13){b(this.value,$(this).attr("keyword-content-selector"));this.value="";$(this).autocomplete("close");return false}return true});$(".q-textfield").bind("autocompletechange",function(f){b(this.value,$(this).attr("keyword-content-selector"));this.value="";return false});var a={},d;$(".q-textfield").autocomplete({minLength:1,autofill:true,delay:100,source:function(g,e){var f=g.term;d=$.getJSON(keywordsJsonURL,g,function(i,h,j){if(i.indexOf(f)<0){i.unshift(f.toString())}a[f]=i;if(j===d){e(i)}})},select:function(e,f){b(f.item.value,$(this).attr("keyword-content-selector"));this.value="";$(".q-textfield").val("");return false},html:true})});var dateFormat=function(){var a=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,b=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,e=/[^-+\dA-Z]/g,d=function(g,f){g=String(g);f=f||2;while(g.length<f){g="0"+g}return g};return function(j,w,r){var h=dateFormat;if(arguments.length==1&&Object.prototype.toString.call(j)=="[object String]"&&!/\d/.test(j)){w=j;j=undefined}j=j?new Date(j):new Date;if(isNaN(j)){throw SyntaxError("invalid date")}w=String(h.masks[w]||w||h.masks["default"]);if(w.slice(0,4)=="UTC:"){w=w.slice(4);r=true}var u=r?"getUTC":"get",n=j[u+"Date"](),f=j[u+"Day"](),k=j[u+"Month"](),q=j[u+"FullYear"](),t=j[u+"Hours"](),l=j[u+"Minutes"](),v=j[u+"Seconds"](),p=j[u+"Milliseconds"](),g=r?0:j.getTimezoneOffset(),i={d:n,dd:d(n),ddd:h.i18n.dayNames[f],dddd:h.i18n.dayNames[f+7],m:k+1,mm:d(k+1),mmm:h.i18n.monthNames[k],mmmm:h.i18n.monthNames[k+12],yy:String(q).slice(2),yyyy:q,h:t%12||12,hh:d(t%12||12),H:t,HH:d(t),M:l,MM:d(l),s:v,ss:d(v),l:d(p,3),L:d(p>99?Math.round(p/10):p),t:t<12?"a":"p",tt:t<12?"am":"pm",T:t<12?"A":"P",TT:t<12?"AM":"PM",Z:r?"UTC":(String(j).match(b)||[""]).pop().replace(e,""),o:(g>0?"-":"+")+d(Math.floor(Math.abs(g)/60)*100+Math.abs(g)%60,4),S:["th","st","nd","rd"][n%10>3?0:(n%100-n%10!=10)*n%10]};return w.replace(a,function(m){return m in i?i[m]:m.slice(1,m.length-1)})}}();dateFormat.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};dateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]};Date.prototype.format=function(a,b){return dateFormat(this,a,b)};