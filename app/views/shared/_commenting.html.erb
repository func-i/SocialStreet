<% content_for :end_of_body do %>
  <script>
    $(function() {
      $('form.comment-form').bind('ajax:beforeSend', function(e, xhr, settings) {
        $('button.comment-button').attr('disabled', 'disable');
        $('#comment-box').fadeTo('fast', 0.3);
        return true;
      }).bind('ajax:success', function(e, data, status, xhr) {
        $('#comment_body').val('');
        $('button.comment-button').attr('disabled', null);
        $('#comment-box').fadeTo('slow', 1);
        var $elem = $(data).hide();
        var $list = $('#action-list');
        $list.prepend($elem);
        $elem.slideDown('fast');
      }).bind('ajax:error', function(e, xhr, status, error) {
        if (xhr.status == 401) {
          window.location.href = '<%= new_user_session_path %>';
        } else {
          alert('Error occurred:' + error);
        }
        $('button.comment-button').attr('disabled', null);
        $('#comment-box').fadeTo('slow', 1);
      });

      $('#comment_body').click(function(){ $('form.comment-form').addClass('send'); return false;});
      $(document).bind("click", function() { $('form.comment-form').removeClass('send');});


      $('form.action-subcomment-form').live('ajax:beforeSend', function(e, xhr, settings) {
        var $form = $(e.target);
        $form.find('button').attr('disabled', 'disabled');
        var $container = $form.closest('.action-comment-container');
        $container.fadeTo('fast', 0.3);
        return true;
      }).live('ajax:success', function(e, data, status, xhr) {
        var $form = $(e.target);
        var $elem = $(data).hide();
        var $container = $form.closest('.action-comment-container');
        $form.find('button').attr('disabled', null);
        $form.find('textarea').val('');
        $container.fadeTo('fast', 1.0).before($elem);
        $elem.slideDown('fast');
      }).bind('ajax:error', function(e, xhr, status, error) {
        if (xhr.status == 401) {
          window.location.href = '<%= new_user_session_path %>';
        } else {
          alert('Error occurred:' + error);
        }
        var $form = $(e.target);
        var $container = $form.closest('.action-comment-container');
        $form.find('button').attr('disabled', null);
        $container.fadeTo('fast', 1.0).before($elem);
      });

      $('.create-comment-link').live('click',function() {
        var $this = $(this);
        $this.closest('.post').find('.action-comment-container').slideToggle('fast').find('textarea').focus();
        return false;
      });
    });
  </script>
<% end %>