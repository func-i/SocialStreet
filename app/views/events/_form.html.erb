<%= form.error_messages %>

<fieldset>
  <%= form.hidden_field :action_id %>
  <div class="row">
    <label for="what">What?</label>
    <%= text_field_tag 'event[searchable_attributes][keywords][]', params[:q], :type => "text", :title => "What?", :class => "q-textfield text_field do-not-submit text", :placeholder => "Enter keywords here...", "keyword-content-selector" => '#event-keywords' %>
  </div>
  <ul id="event-keywords" class="keyword">
    <% (event.searchable.keywords || []).each do |keyword| %>
      <% unless keyword.blank? %>
        <li class="keyword-pill">
          <%= keyword %><%= link_to("close", '#', :class => "close remove-parent", "data-parent-selector" => ".keyword-pill") %>
          <input type="hidden" name="event[searchable_attributes][keywords][]" value="<%= keyword %>" />
        </li>
      <% end %>
    <% end %>
  </ul>

  <div class="row"> 
    <label for="where">Where?</label>

    <%= form.fields_for :searchable do |searchable_fields| %>
      <%= searchable_fields.fields_for :location do |location_fields| %>
        <%= location_fields.text_field :text , :class => "text text_field location-name-field", :type => "text", :id=>"where", :title=> "Where?" %>
        <%= location_fields.hidden_field :latitude, :id => "location-lat-field" %>
        <%= location_fields.hidden_field :longitude, :id => "location-lng-field" %>
      <% end %>
    <% end %>
  </div>
  <div id="event-location-map" class="row-map" style="height:300px">
    <!--img width="497" height="229" src="images/img-map.png" alt="image description"/-->
  </div>

  <div class="row-when">
    <span>When?</span>

    <%= form.fields_for :searchable do |searchable_fields| %>
      <%= searchable_fields.fields_for :searchable_date_ranges do |date_range_fields| %>
        <div class="col">
          <span><label for="date">Start Date:</label></span>
          <%= date_range_fields.datetime_select :starts_at, :start_year => Time.now.year, :minute_step => 15 %> <%= Time.zone.now.zone %>
        </div>
        <div class="col" id="EndDateTime" style="display:none">
          <span><label for="time">End Date and time (Timezone: <%= Time.zone.now.zone %>)</label></span>
          <%= date_range_fields.datetime_select :ends_at, :start_year => Time.now.year, :minute_step => 15 %> <%= Time.zone.now.zone %>
        </div>
        <%= link_to_function "Add End Date & Time", "$('#EndDateTime').toggle(); $('#exclude_end_date').val(0)" %>
      <%  end %>
    <%- end -%>
  </div>

  <div class="title-row">
    <p><%= link_to_function "+ Title, Description, Event Icon", "$('#row-title').toggle()" -%></p>
  </div>

  <div id="row-title" style="display:none;">
    <div class="col">
      <label for="title">Title</label>
      <%= form.text_field :name, :rows => 10, :cols => 80, :class => "text_field text" %>
    </div>

    <div class="col">
      <label class="label">Description</label>
      <%= form.text_area :description, :rows => 10, :cols => 80, :class => "text_area text" %>
    </div>

    <div class="col">
      <label class="label">Image</label>
      <%= image_tag(event.photo.thumb.url) if event.photo? %>
      <%= form.file_field :photo %>
    </div>
  </div>

  <div class="row-btn">
    <%= submit_tag "Save", :class => "btn" -%>
    or <a href="#" class="link-close">cancel</a>
  </div>
</fieldset>

<%# content_for :end_of_body do %>
<!--<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>-->
<script>
  var keywordsJsonURL   = "<%= event_types_path(:format => :json) %>";
  var keywordsParamKey  = "event[searchable_attributes][keywords][]";
  var locationSearchURL = '<%= locations_path(:format => :json) %>';
</script>

<%= javascript_include_tag 'marker_clusterer', 'events/organizer_map', 'gmaps/shared', 'events/form', 'keywords_field' %>
<% if event.location.try(:geo_located?) %>
  <script>
    $(function() {
      placeMarker(new google.maps.LatLng(<%= event.location.latitude %>, <%= event.location.longitude %>), $('.location-name-field').val());
    });
  </script>
<%- elsif event.new_record? -%>
  <script>

    var refreshTimer = null;

    function getSearchParams() {

      var bounds = map.getBounds();
      ne = bounds.getNorthEast();
      sw = bounds.getSouthWest();
      c = bounds.getCenter();

      var str = '?map_bounds=' + ne.lat() + ',' + ne.lng() + ',' + sw.lat() + ',' + sw.lng();
      if($('[name="event\\[searchable_attributes\\]\\[keywords\\]\\[\\]"]').length > 0)
        return str + "&" + $('[name="event\\[searchable_attributes\\]\\[keywords\\]\\[\\]"]').serialize();
      else
        return str;

    }

    function createEventMarker(location, title) {

      var marker = new google.maps.Marker({
        position: location,
        title: title
      });

      google.maps.event.addListener(marker, 'click', function() {
        //selectMarker(marker, true); //Commented out until proper functionality is determined
      });
      markers.push(marker);
    }

  </script>
  <%# end %>


<% end %>
