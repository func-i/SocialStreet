<%= form.error_messages %>

<fieldset>
  <%= form.hidden_field :action_id %>

  <div class="row">
    <label for="what">What?</label>
    <%= text_field_tag 'event[searchable_attributes][keywords][]', params[:q], :id=>"what", :type => "text", :title => "What?", :class => "q-textfield text_field do-not-submit text", :placeholder => "Enter keywords here..." %>
  </div>
  <ul id="keywords" class="keyword">
    <% (@event_for_create.searchable.keywords || []).each do |keyword| %>
      <% unless keyword.blank? %>
        #TODO - Fix javascript
        <li class="keyword-pill">
          <%= keyword %><a href="#" class="close">close</a>
          <input type="hidden" name="event[searchable_attributes][keywords][]" value="<%= keyword %>" />
        </li>
      <% end %>
    <% end %>
  </ul>

  <div class="row">
    <label for="where">Where?</label>

    <%= form.fields_for :searchable do |searchable_fields| %>
      <%= searchable_fields.fields_for :location do |location_fields| %>
        <%= location_fields.text_field :text , :class => "text text_field location-name-field", :type => "text", :id=>"where", :title=> "Where?" %>
        <%= location_fields.hidden_field :latitude, :id => "location-lat-field" %>
        <%= location_fields.hidden_field :longitude, :id => "location-lng-field" %>
      <% end %>
    <% end %>
  </div>
  <div id="event-location-map" class="row-map">
    <!--img width="497" height="229" src="images/img-map.png" alt="image description"/-->
  </div>

  <div class="row-when">
    <span>When?</span>

    <%= form.fields_for :searchable do |searchable_fields| %>
      #TODO
      <div class="col">
        <span><label for="date">Start Date:</label></span>

      </div>
      <div class="col">
        <span><label for="time">Start Time:</label></span>
      </div>
      <a href="#">+ Add an End Date and Time</a>
    <%end%>
  </div>

  <div class="title-row">
    <p><a href="#">+ Title, Description, Event Icon</a></p>
  </div>

  <div class="row-btn">
    <a href="#" class="btn"><span>Save</span></a>
    or <a href="#">cancel</a>
  </div>
</fieldset>

<% content_for :end_of_body do %>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script>
  var keywordsJsonURL   = "<%= event_types_path(:format => :json) %>";
  var keywordsParamKey  = "event[searchable_attributes][keywords][]";
  var locationSearchURL = '<%= locations_path(:format => :json) %>';
</script>
<%= javascript_include_tag 'events/form', 'events/organizer_map', 'keywords_field', 'gmaps/shared', 'marker_clusterer' %>
<% if @event_for_create.location.try(:geo_located?) %>
  <script>
    $(function() {
      placeMarker(new google.maps.LatLng(<%= @event_for_create.location.latitude %>, <%= @event_for_create.location.longitude %>), $('.location-name-field').val());
    });
  </script>
<%- elsif @event_for_create.new_record? -%>
  <script>

    var refreshTimer = null;

    function getSearchParams() {

      var bounds = map.getBounds();
      ne = bounds.getNorthEast();
      sw = bounds.getSouthWest();
      c = bounds.getCenter();

      var str = '?map_bounds=' + ne.lat() + ',' + ne.lng() + ',' + sw.lat() + ',' + sw.lng();
      if($('[name="event\\[searchable_attributes\\]\\[keywords\\]\\[\\]"]').length > 0)
        return str + "&" + $('[name="event\\[searchable_attributes\\]\\[keywords\\]\\[\\]"]').serialize();
      else
        return str;
         
    }

    function refreshResults() {
      if (refreshTimer) {
        clearInterval(refreshTimer);
        delete refreshTimer;
      }
      refreshTimer = setTimeout(function() {
        $.getScript('load_events' + getSearchParams());
      }, 250);
    }

    function createEventMarker(location, title) {

      var marker = new google.maps.Marker({
        position: location,
        title: title
      });

      google.maps.event.addListener(marker, 'click', function() {
        //selectMarker(marker, true); //Commented out until proper functionality is determined
      });
      markers.push(marker);
    }

  </script>
<% end %>


<% end %>
