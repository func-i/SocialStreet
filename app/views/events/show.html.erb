<% content_for :main_top do %>
  <div class="col1">
    <%# if @event.editable_time? && @rsvp%>
      <% if @event.editable_by?(current_user) %>
        <div class="admin-view">
          <strong>
            <%= link_to_popup_modal_ajax  'Edit', 'Edit this StreetMeet', 'empty_modal_base', edit_event_path(@event), nil, nil%>
          </strong>
          <% if @event.user == current_user %>
            or
            <strong>
              <%= link_to_popup_modal_ajax  '+administrators', 'Add Administrators', 'empty_modal_sidebar', new_event_administrator_path(@event, :js), nil, nil%>
            </strong>
          <% end %>
        </div>
      <% end %>
    <% #end %>
  </div>
  <div class="col2"></div>
<% end %>

<div class="profile">
  <div class="profile-holder">
    <%= image_tag(url_for_event_image(@event), :size => "80x80", :class => "avatar") %>
    <div class="text">
      <div class="row">
        <div class="text-content">
          <h2><%= @event.title %></h2>
          <p>
            <%=address_for(@event.location)%>
          </p>
        </div>

        <%= link_to "Share", [:post_to_facebook, @event], :remote=>true, :id => 'fb-share', :class => "btn-share" -%>

      </div>
      <div class="info">
        <div id="attend-button" class="col">

          <%- if !@event.canceled? && @event.editable_time?%>

            <%= render :partial => "shared/attending_buttons", :locals => {:rsvp => @rsvp, :event => @event} %>

          <%- end -%>
        </div>
        <div class="col-holder">
          <div class="col">
            <span>Start Day:</span>
            <strong><%= @event.starts_at.strftime("%B %d") %></strong>
          </div>
          <% if @event.finishes_at && @event.end_date != @event.start_date %>
            <div class="col">
              <span>End Day:</span>
              <strong><%= @event.finishes_at.strftime("%B %d") %></strong>
            </div>
          <%- end -%>
          <div class="col">
            <span>Start Time:</span>
            <strong><%= @event.starts_at.strftime("%l:%M %p") -%></strong>
          </div>
          <% if @event.finishes_at %>
            <div class="col">
              <span>End Time:</span>
              <strong><%= @event.finishes_at.strftime("%l:%M %p") -%></strong>
            </div>
          <%- end -%>
        </div>
      </div>
    </div>
  </div>

  <div class="keyword">
    <%- @event.searchable_event_types.each do |set| -%>
      <span><%= set.name %></span>
    <%- end -%>
  </div>

  <div class="description">
    <%=@event.description if !@event.description.blank?%>
  </div>

</div>
<div class="post-message">
  <%= form_for [@event, @comment], :remote => true, :html => {:class => "form-post-message Post-Message form comment-form form-comment" } do |form| %>
    <fieldset>

      <div class="box text">
        <div class="topleft">
          <div class="topright">
            <div>
              <%= form.text_area :body, :title => "Post a Message", :class => "textarea", :placeholder => "Leave a message", :rows => 1 -%>
              <div style="clear:both">&nbsp;</div>
            </div>
          </div>
        </div>

        <div class="bottomleft">
          <div class="bottomright">
          </div>
        </div>
      </div>
      <div style="width: 100%; background-image: url('/images/bg-form-post-message-large_bottom.png'); height: 11px; margin-top: -2px;"></div>
      <div class="info">
      </div>
    </fieldset>
  <%- end -%>
<%#= render 'shared/commenting' %>

</div>
<div id="comment-box" class="post-holder Post-Holder" >
  <div id="action-list">
    <% @actions.each do |action| %>

      <div class="post">
        <%= render "shared/records", :record_type => RecordType.types[:plain_thread], :record => action %>
      </div>

    <% end %>

<%#=  render :partial => 'actions' %>
  </div>
</div>

<% content_for :sidebar do %>

  <div class="box map">
    <div class="heading">
      <h3>
        <%if @event.location.geocoded_address%>
          <%="#{@event.location.geocoded_address}"%>
        <%else %>
          <%="#{@event.location.street} #{@event.location.city}, #{@event.location.state}" %>
        <%end%>
      </h3>
    </div>
    <div class="map-holder">
      <% if @event.geo_located? %>
        <img src="http://maps.google.com/maps/api/staticmap?zoom=14&size=317x217&maptype=roadmap&sensor=false&markers=icon:http://staging.socialstreet.com/images/map_pin.png%7C<%= @event.latitude %>,<%= @event.longitude %>"
             alt="location map" />
           <% end %>
    </div>
  </div>

  <div class="box people-list">
    <div class="heading">
      <h3>Attending</h3>
      <%= link_to_popup_modal "View all", "show-attendees", :class => "btn-view"%>
    </div>
    <div class="box-content">
      <ul class="list-img">
        <% @event.attendees_rsvps_list.each do |attendee_rsvp| %>
          <li class="attendee_<%=attendee_rsvp.user.id%>"><%= render 'shared/user_list_element', :user => attendee_rsvp.user%></li>
        <% end %>
      </ul>
    </div>
  </div>

  <div class="box people-list">
    <div class="heading">
      <h3>Organizers</h3>
      <%= link_to_popup_modal "View all", "show-organizers", :class => "btn-view"%>
    </div>
    <div class="box-content">
      <ul class="list-img">
        <% @event.administrators_rsvps_list.each do |administrator_rsvp| %>
          <li class="attendee_<%=administrator_rsvp.user.id%>"><%= render 'shared/user_list_element', :user => administrator_rsvp.user%></li>
        <% end %>
      </ul>
    </div>
  </div>

<% end %>

<%= content_for :popup_modals do -%>
  <div id="show-attendees" class="pop-up pop-up-modal" style="display:none; position: fixed;">
    <div class="pop-up1">

      <div class="heading">
        <strong>Attendees</strong>
        <%= link_to "close", '#', :class => "btn-close" -%>
      </div>

      <div class="content">
        <div class="pop-up1-content view-all-modal">
          <ul>

            <% @attendees_rsvps.each do |rsvp| %>

              <li class="attendee_<%=rsvp.user.id%>">
                <%= avatar rsvp.user :size => "44x40" %>
                <div class="text-holder">
                  <% if rsvp.user.fb_uid? && user_signed_in? && current_user.can_friend?(rsvp.user) %>
                    <%= link_to '#', :class => "add-to-fb-button add", "data-fb-uid" => rsvp.user.fb_uid do %>
                      <span>Add to Facebook</span>
                    <% end %>
                  <% end %>
                  <strong class="ttl"><%= link_to rsvp.user.name, profile_path(rsvp.user) %></strong>
                </div>
              </li>

            <% end %>

          </ul>
        </div>
      </div>
    </div>
  </div>

  <div id="show-organizers" class="pop-up pop-up-modal" style="display:none; position: fixed;">
    <div class="pop-up1">

      <div class="heading">
        <strong>Organizers</strong>
        <%= link_to "close", '#', :class => "btn-close" -%>
      </div>

      <div class="content">
        <div class="pop-up1-content view-all-modal">
          <ul>
            <% @administrators_rsvps.each do |rsvp| %>
              <li class="attendee_<%=rsvp.user.id%>">
                <%= avatar rsvp.user :size => "44x40" %>
                <div class="text-holder">
                  <% if rsvp.user.fb_uid? && user_signed_in? && current_user.can_friend?(rsvp.user) %>
                    <%= link_to '#', :class => "add-to-fb-button add", "data-fb-uid" => rsvp.user.fb_uid do %>
                      <span>Add to Facebook</span>
                    <% end %>
                  <% end %>
                  <strong class="ttl"><%= link_to rsvp.user.name, profile_path(rsvp.user) %></strong>
                </div>
              </li>

            <% end %>

          </ul>
        </div>
      </div>
    </div>
  </div>

  <% unless params[:invite].blank? %>
    <script type='text/javascript'>
      // TODO this should popup the modal by default
      $(function(){
        popup_modal_ajax('#empty_modal_sidebar', 'Invite your friends', '<%=load_modal_event_rsvp_invitation_path(@event, @rsvp, :js)%>', null);
      });
    </script>

  <% end %>

<%- end -%>

<% content_for :end_of_body do %>

  <%= javascript_include_tag 'ss_pageless' %>

  <script type='text/javascript'>
    var showEventPageless = null;

    function makeShowEventPageless(){
      showEventPageless = new Pageless({
        loaderContainer: '#action-list',
        totalPages: <%= @num_pages -%>,
        currentPage: 1,
        url: '<%= @event %>'
      });
      showEventPageless.start();
    }

    function getShowEventPageless(){
      return showEventPageless;
    }

    $(function() {
      makeShowEventPageless();

  <% if params[:post_to_facebook] %>
      $('#flash-messages').html('<div class="flash"><strong>The StreetMeet has been posted to your Facebook wall</strong></div>');
  <% end %>
  });

  </script>
<% end %>
