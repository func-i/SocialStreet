<div class="box box1">
  <div class="heading">
    <h3>When?</h3>
    <div class="jump-date" style="display:inline; width: none;">
      <div class="col" style="height:0;float:right;">
        <span style="font-size: 9px;">Jump To:</span><%= text_field_tag 'from_date', params[:from_date] || Date.today, :class => "text_field", :style => "width: 80px; background: none; border: none;font-size:12px; margin-top: -7px;" %>
      </div>
    </div>
    <a id="when_btn" href="#" class="btn" <%='style=background-position:-16px 0;' if params[:view] == "map"%>>close</a>
  </div>
  <div id="sidebar_when_box_content" class="box-content" <%= 'style=display:none;' if params[:view] == "map"%>>
    <div class="time-slot">
      <div class="col1">
        <div class="ttl">Availability:</div>
        <div class="row">Morning</div>
        <div class="row">Afternoon</div>
        <div class="row">Evening</div>
      </div>
      <div class="col2">
        <div class="days-week">
          <div>
            <span>Sun</span>
            <span>Mon</span>
            <span>Tue</span>
            <span>Wed</span>
            <span>Thu</span>
            <span>Fri</span>
            <span>Sat</span>
          </div>
        </div>
        <table>
          <%- 3.times do |tm| -%>
            <tr>
              <%- 7.times do |day| -%>
                <%= content_tag("td", :class => "calendar-times", "d-pos" => "#{day},#{tm}") do -%>
                  <%- unless params[:date_search].blank? -%>
                    <%- if params[:date_search].include?("#{day},#{tm}") -%>
                    <script>
                      $('td[d-pos="<%= "#{day},#{tm}" -%>"]').addClass('select')
                      $('form.search-params').append('<input type="hidden" name="date_search[]" value="<%= "#{day},#{tm}" -%>" />');
                    </script>
                  <%- end -%>
                <%- end -%>

                <span></span>
              <%- end -%>
            <%- end -%>
            </tr>
          <%- end -%>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  $('#when_btn').click(function(){
    $('#sidebar_when_box_content').slideToggle('fast', function() {
      if($('#when_btn').css("background-position") == "0px 0px")
        $('#when_btn').css("background-position", "-16px 0");
      else
        $('#when_btn').css("background-position", "0px 0px");
   
      if(typeof checkMapPageSize == 'function')
        checkMapPageSize();
    
    });
    return false;
  });

  function closeWhenBox(){
    $('#sidebar_when_box_content').hide('fast');

    $('#when_btn').css("background-position", "-16px 0");

    if(typeof checkMapPageSize == 'function')
      checkMapPageSize();
  }

  $('.calendar-times').click(function() {
    if($(this).hasClass('select')){
      // The day is selected, remove class and remove search conditions
      $(this).removeClass('select');
      $('form.search-params input[type="hidden"][value="'+ $(this).attr('d-pos') +'"]').remove();
    }
    else {
      $(this).addClass('select');
      $('form.search-params').append('<input type="hidden" name="date_search[]" value="' + $(this).attr('d-pos') + '" />');
    }

    if(history && history.pushState)
      history.pushState(null, null, getSearchParams());
    refreshResults("explore");
  });
</script>